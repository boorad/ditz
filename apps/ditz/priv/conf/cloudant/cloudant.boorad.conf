{servers,
 [
  {'ditz1@node1.boorad.local',
   [
    {nodelist, [{1, 'node1@node1.boorad.local', "http://node1.boorad.local:5984/"},
                {2, 'node2@node2.boorad.local', "http://node2.boorad.local:5985/"},
                {3, 'node3@node3.boorad.local', "http://node3.boorad.local:5986/"},
                {4, 'node4@node4.boorad.local', "http://node4.boorad.local:5987/"}]},
    {options, [
               {base_dir, "/Users/brad/dev/erlang/dbcore/"},
               {etc_dir, "rel/dbcore/etc/"},
               {pid_dir, "/srv/run/couchdb/"},
               {data_dir, "/srv/db{{nodenum}}/"},
               {start_cmd, "{{base_dir}}rel/dbcore/bin/node {{nodenum}} {{nodename}}"},
               {stop_cmd, "kill `cat {{pid_dir}}couchdb{{nodenum}}.pid`"}
              ]}
   ]
  }
 ]
}.
{tests,
 [
  {test1, "cloudant test: start cluster, do some tests, shut cluster down",
   [
    % stop nodes if any are running
    {{cloudant, stop_nodes, all}, equal, ok},

    % wipe old cluster info
    {{cloudant, wipe, [data, all]}, equal, ok},
    {{cloudant, wipe, [couch, all]}, equal, ok},
    {{cloudant, wipe, [state, all]}, equal, ok},

    % start cluster nodes
    {{cloudant, start_nodes, all}, equal, ok},
    {{timer, sleep, 1000}, equal, ok},

    % assert membership is in pre-init state (no init or joins yet)
    {{httpc, get, [2, "_cloudant/membership"]}, equal,
                   "{\"all_nodes\":[\"node2@node2.boorad.local\"],"
                   "\"cluster_nodes\":[]}\n"},

    % initialize cluster
    {{httpc, post, [1, "_cloudant/membership",
                    "@{{conf_dir}}cloudant/json/init1.json"]},
                    equal, "{\"result\":\"ok\",\"error\":null,\"id\":1}\n"},

    % assert membership has been initialized
    {{httpc, get, [3, "_cloudant/membership"]}, equal,
                   "{\"all_nodes\":["
                   "\"node1@node1.boorad.local\","
                   "\"node2@node2.boorad.local\","
                   "\"node3@node3.boorad.local\""
                   "],"
                   "\"cluster_nodes\":["
                   "\"node1@node1.boorad.local\","
                   "\"node2@node2.boorad.local\","
                   "\"node3@node3.boorad.local\""
                   "]}\n"},

    % join new node to cluster
    {{httpc, post, [4, "_cloudant/membership",
                    "@{{conf_dir}}cloudant/json/join1.json"]},
                    equal, "{\"result\":\"ok\",\"error\":null,\"id\":1}\n"},

    % assert membership has added new node
    {{httpc, get, [2, "_cloudant/membership"]}, equal,
                   "{\"all_nodes\":["
                   "\"node1@node1.boorad.local\","
                   "\"node2@node2.boorad.local\","
                   "\"node3@node3.boorad.local\","
                   "\"node4@node4.boorad.local\""
                   "],"
                   "\"cluster_nodes\":["
                   "\"node1@node1.boorad.local\","
                   "\"node2@node2.boorad.local\","
                   "\"node3@node3.boorad.local\","
                   "\"node4@node4.boorad.local\""
                   "]}\n"},

    % stop all cluster nodes
    {{cloudant, stop_nodes, all}, equal, ok},

    % for dev, and ending commas
    {{timer, sleep, 1}, equal, ok}
   ]
  }
 ]
}.
