{
 test1,
 "cloudant test: start, init cluster, join new node, shut cluster down",
 config1,
 [
  {setup, setup1},

  % assert membership is in pre-init state (no init or joins yet)
  {{httpclient, get, [2, "_cloudant/membership"]}, equal,
                 "{\"all_nodes\":[\"node2@node2.boorad.local\"],"
                 "\"cluster_nodes\":[]}\n"},

  % initialize cluster
  {{httpclient, post, [1, "_cloudant/membership",
                  "@{{json_dir}}/init1.json"]},
                  equal, "{\"result\":\"ok\",\"error\":null,\"id\":1}\n"},

  % assert membership has been initialized
  {{httpclient, get, [3, "_cloudant/membership"]}, equal,
                 "{\"all_nodes\":["
                 "\"node1@node1.boorad.local\","
                 "\"node2@node2.boorad.local\","
                 "\"node3@node3.boorad.local\""
                 "],"
                 "\"cluster_nodes\":["
                 "\"node1@node1.boorad.local\","
                 "\"node2@node2.boorad.local\","
                 "\"node3@node3.boorad.local\""
                 "]}\n"},

  % join new node to cluster
  {{httpclient, post, [4, "_cloudant/membership",
                  "@{{json_dir}}/join1.json"]},
                  equal, "{\"result\":\"ok\",\"error\":null,\"id\":1}\n"},

  % wait for node to come up
  {{cloudant, nodeup, [2, 4]}, equal, ok},

  % assert membership has added new node
  {{httpclient, get, [2, "_cloudant/membership"]}, equal,
                 "{\"all_nodes\":["
                 "\"node1@node1.boorad.local\","
                 "\"node2@node2.boorad.local\","
                 "\"node3@node3.boorad.local\","
                 "\"node4@node4.boorad.local\""
                 "],"
                 "\"cluster_nodes\":["
                 "\"node1@node1.boorad.local\","
                 "\"node2@node2.boorad.local\","
                 "\"node3@node3.boorad.local\","
                 "\"node4@node4.boorad.local\""
                 "]}\n"},

  {teardown, teardown1}
 ]
}.
